<!DOCTYPE html>
<html>
	<head>
		<title>Crime Map 2 (Emerald Media Group)</title>

		<style type="text/css">
			html, body {
				margin: 0;
				padding: 0;
				width: 100%;
				height: 100%;
			}
			#wrapper {
				font-family: "Helvetica";
				font-size: 14px;
				width: 100%;
				height: 100%;
				color: #333;
			}
			#map {
				width: 100%;
				height: 100%;
				margin: 0;
				padding: 0;
			}
			#list-wrapper {
				float: left;
				width: 300px;
				height: 750px;
				overflow: scroll;
			}
			#list-wrapper ul {
				list-style: none;
				margin: 0;
				padding: 0;
				margin-top: 10px;
			}
			#list-wrapper li {
				margin-right: 10px;
				padding-left: 10px;
				padding-bottom: 10px;
				margin-bottom: 10px;
				border-bottom: 1px solid #CCC;
			}
			#controls {
				position: fixed;
				height: 900px;
				width: 200px;
				bottom: 0px;
				left: 0;
				background: #EEE;
			}
			input {
			}
			label {
				font-size: 10px;
			}
		</style>

	</head>
	<body>

		<div id="wrapper">
			<div id="map"></div>
			<div id="controlsnope"></div>
		</div>

		<script src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
		<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
		<script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.2/underscore-min.js"></script>
		<script>
			get_random_color = function() {
				var letters = '0123456789ABCDEF'.split('');
				var color = '#';
				for (var i = 0; i < 6; i++) {
					color += letters[Math.round(Math.random() * 15)];
				}
				return color;
			}
			color_lookup = {};
			build_colors = function() {
				incident_types = _.uniq(_.pluck(data, "incident_description"));
				for (var i = 0, l = incident_types.length; i < l; i++) {
					color_lookup[incident_types[i]] = get_random_color();
				}
			}
			whitelist = ["ATL Drunk Driver", "Accident, Bike", "Accident, Vehicle-Bike", "Accident, Vehicle-Pedestrian", "Animal Complaint", "Animal Cruelty", "Assault", "Assist Fire Dept.", "Assist State Police", "Burglary", "Controlled Substance Violation", "Criminal Mischief", "Criminal Mistreatment", "Criminal Trespass", "Dispute", "Drug Overdose", "Fight", "Fraud", "Graffiti Calls", "Harassment", "Hazard, Safety", "Hit & Run", "Hit & Run Injury", "Illegal Camping", "Injured Animal(s)", "Intoxicated Subject(s)", "Location Runaway(s)", "Location Wanted Subject", "Loud Noise", "Open Container", "Prowler(s)", "Reckless Burning", "Reckless Driving", "Repossessed Vehicle(s)", "Shot(s) Fired", "Speeding Vehicle(s)", "Subject(s) Down", "Suicidal Subject(s)", "Suspicious Condition(s)", "Suspicious Subject(s)", "Suspicious Vehicle(s)", "Theft", "Theft ID", "Theft from Vehicle", "Theft of Services", "Traffic Hazard"];

			data_endpoint = "http://crime.dailyemerald.com/incidents.json?callback=jsoncallback";

			make_checkbox = function(id, label) {
				var new_checkbox = $('<input type="checkbox" />').attr('id', id).attr('checked', 'true');
				var new_label = $('<label>' + label + '</label><br>').attr('for', id)
				$("#controls").append(new_checkbox).append(new_label);
			}
			safe_name = function(unsafe) {
				return unsafe.toLowerCase().replace(/[^a-z]+/g, '');
			}

			$(document).ready(function() {
				$('#controls input').on('change', function() {
					console.log($(this).attr('id'));
					var currently_checked = [];
					$("input").each(function() {
						if ( typeof $(this).attr('checked') != 'undefined') {
							currently_checked.push($(this).attr('id'));
						}
					});
					console.log(currently_checked);

				});
			});

			filters = {}
			filter_keys = [];
			setup_filters = function() {
				incident_types = _.uniq(_.pluck(data, "incident_description")).sort();
				// thank you, underscore.js
				for (var i = 0, l = incident_types.length; i < l; i++) {
					var safe_description = safe_name(incident_types[i]);
					filters[safe_description] = incident_types[i]
					filter_keys.push(safe_description);

					make_checkbox(safe_description, incident_types[i]);
				}

			}

			window.jsoncallback = function(incidents) {
				window.data = incidents;
				// for console ease
				//window.build_colors();
				setup_filters();
				console.log("before filter, count is", incidents.length);
				incidents = _.filter(incidents, function(i) {
					//console.log(i.incident_description, whitelist.indexOf(i.incident_description));
					return whitelist.indexOf(i.incident_description) > -1
				});
				console.log("after filter, count is", incidents.length);

				for (var i = 0, l = incidents.length; i < l; i++) {

					var marker = new google.maps.Marker({
						position : new google.maps.LatLng(incidents[i].latitude, incidents[i].longitude),
						map : window.map,
						title : "<b>" + incidents[i].incident_description + "</b><br>" + incidents[i].received_raw + "<br>" + incidents[i].location
					});

					/*
					 var options = {
					 strokeColor: color_lookup[ incidents[i].incident_description ],
					 strokeOpacity: 0.8,
					 strokeWeight: 2,
					 fillColor: color_lookup[ incidents[i].incident_description ],
					 fillOpacity: 0.8,
					 map: window.map,
					 center: new google.maps.LatLng(incidents[i].latitude, incidents[i].longitude),
					 title: "<b>"+incidents[i].incident_description+"</b><br>"+incidents[i].received_raw + "<br>" + incidents[i].location,
					 radius: 100
					 };
					 var marker = new google.maps.Circle(options);
					 */
					google.maps.event.addListener(marker, 'click', function() {
						window.infowindow.content = this.title;
						window.infowindow.open(window.map, this);
					});
				}
			}

			window.initialize = function() {
				var mapOptions = {
					zoom : 14,
					center : new google.maps.LatLng(44.042748, -123.07668),
					mapTypeId : google.maps.MapTypeId.ROADMAP
				};
				window.map = new google.maps.Map(document.getElementById('map'), mapOptions);
				window.infowindow = new google.maps.InfoWindow({
					content : ""
				});

				var headID = document.getElementsByTagName("head")[0];
				var newScript = document.createElement('script');
				newScript.type = 'text/javascript';
				newScript.src = window.data_endpoint;
				headID.appendChild(newScript);

			}
			google.maps.event.addDomListener(window, 'load', initialize);
		</script>

	</body>
</html>